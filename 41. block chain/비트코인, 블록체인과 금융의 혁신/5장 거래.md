## 들어가기

거래란 비트코인 시스템 내에 있는 참가자들 간 가치를 전송하는 행위를 인코딩한 데이터 구조를 말한다. 각 거래는 전 세계적인 복식부기 장부에 들어있는 공개된 항목이다. 

5장에서는 다양한 형태의 거래, 거래에 포함된 내용, 거래 생성 방법, 거래 승인 방법, 한 거래가 거래 전체의 영구적인 기록의 일부가 되는 방법 등을 살펴볼 것이다. 



## 거래의 수명주기

거래의 수명주기는 거래가 생성되는 단계부터 시작한다. 생성된 거래에서 해당 거래가 참조하는 금액을 소비하기 위해서는 승인을 의미하는 서명을 한 건 이상 받아야 한다. 그 후 비트코인 네트워크상에 해당 거래를 알리면 네트워크상에 있는 각 네트워크 노드가 해당 거래를 검증하고 네트워크 내에 있는 노드 (거의) 전부에게 해당 거래가 도착할 때까지 거래를 계속 전파한다. 마지막 단계로 해당 거래가 채굴 노드에 의해서 검증된 후 블록체인에 기록되어 있는 거래들로 구성된 블록 내에 포함된다. 
거래가 블록체인에 기록되고 그 다음 생성되는 블록들에 의해 승인을 받고 나면 해당 거래는 비트코인 장부에 영구적으로 기록되며 모든 참가자들에 의해 유효하다고 인정받는다. 해당 거래를 통해 새로운 소유주에게 할당된 돈은 새로운 거래에서 소비 가능하며, 이를 통해 소유권 사스리 연장되고 거래의 수명주기가 다시 시작된다. 



## 거래 생성하기

거래는 온라인 혹은 오프라인상에서 누구나 생성이 가능하다. 거래를 생성하는 사람이 해당 계좌에 대한 공식 서명인이 아니어도 무방하다. 이전에 발생한 특정 거래를 자금원으로 참조하여 생성한다. 
거래가 생성되고 나면 자금원의 소유주가 해당 거래에 서명한다. 거래가 완전히 생성되고 서명이 완료되고 나면 해당 거래를 유효화되고 돈의 송금에 필요한 모든 정보가 담기게 된다. 마지막으로, 유효한 거래는 공개장부(블록체인)에 포함되기 위해 채굴자들에게 도달할 때 까지 비트코인 네트워크상에서 전파되어야 한다. 



## 비트코인 네트워크에 거래 전송하기

거래가 전파되고 블록체인에 포함되기 위해서는 일단 거래가 비트코인 네트워크에 전달되어야 한다. 비트코인 거래는 300~400 바이트 크기의 데이터로, 수만 개의 비트코인 노드 중 한 곳에 도달해야만 한다. 이때 노드와 송금인은 서로 신뢰할 필요도 신원을 확인할 필요도 없다. 해당 거래는 서명을 받았고 기밀 정보나 개인키, 인증서 등을 포함하고 있지 않기 때문에 공개적으로 전송 될 수 있다. 
비트코인 거래는 와이파이, 블루투스, NFC, 첩(Chirp), 바코드 등 불안정한 네트워크를 통해서 전송되거나 웹 양식으로 복사하기와 붙여넣기를 이용해서도 전송 가능하다. 심지어 주파수, 이모티콘으로 인코딩 될 수 있고, 텍스트 메시지나 스카이프 채팅 메시지 형태로 공개적인 장소에 게재될 수도 있다. 



## 비트코인 네트워크로 거래 전파하기

비트코인 거래가 비트코인 네트워크에 연결된 한 노드로 전송되면 해당 노드에 의해 거래가 유효화 된다. 거래가 유효화되고 나면 해당 노드와 연결된 다른 노드로 이 거래를 전파하고 동시에 성공 메시지가 생성자에게 전달될 것이다. 만약 거래가 유효화되지 못한 경우라면 해당 노드는 승인을 거부하고 동시에 거절 메시지가 생성자에게 돌아갈 것이다. 
비트코인 네트워크는 P2P 기반 네트워크다. 거래와 블록 등의 메시지들은 각 노드로부터 자신과 연결된 다른 이웃 노드로 전파된다. 네트워크상에 있는 노드에 새롭게 추가된 유효화 거래는 주변에 있는 3~4개의 노드로 전송되고 전송된 각각의 거래는 또다시 3~4개의 주변 노드로 전송되며 이 과정이 반복된다. 이런 방식을 이용해 유효 거래는 몇 초 만에 기하급수적으로 전파의 물결을 일으켜 결국 연결된 노드 전체가 해당 거래를 전송받게 된다. 
모든 노드는 독립적으로 모든 거래를 유효화하고 해당 거래를 다른 노드로 전파한다. 잘못된 거래는 한 노드 이상 전파될 수 없다. 



## 거래 구조

거래는 입력값이라고 불리는 자금원에서부터 출력값으로 불리는 목적지까지 가치의 전송을 인코딩하는 데이터 구조다. 입력값과 출력값은 소유주나 비밀키를 알고 있는 사람만이 풀 수 있는 특수 비밀키로 잠겨있다.

표5-1 거래구조

거래 잠금 시간

잠금시간이란 거래 한 건이 블록체인에 추가되는 가장 빠른 시간을 의미한다. 대부분의 거래에서 잠금시간은 0이며 이는 바로 실행 가능한 상태를 의미한다. 잠금 시간이 5억 미만의 경우 블록의 높이로 해석되고 5억 이상인 경우 유닉스 기준일자 타임스탬프로 해석된다. 



## 거래 출력값과 입력값

비트코인 거래로 구성되어 있는 블록을 구성하는 기본 요소는 소비되지 않은 거래 출력값, 즉 UTXO이다. UTXO는 특정 소유주에 대해 암호로 잠겨있고, 블록체인상에 기록되어 있으며, 전체 네트워크에 의해 통화 단위로 인정받은불가분의 비트코인 통화 덩어리이다. 비트코인 네트워크는 현재 수백만 개에 달하는 UTXO중에서 이용 가능한(소비되지 않은) UTXO 전부를 추적한다. 사용자가 비트코인을 수령할 때마다 해당 금액은 블록체인 내에 UTXO로 기록된다. 따라서 수백 개의 거래와 수백 개의 블록들 중에서 사용자의 비트코인은 UTXO의 형태로 산재해 있을 수 있다. 
현실적으로 비트코인 주소 혹은 계좌에 보관된 작액은 있을 수 없다, 즉 특정 소유주에 대해서 잠겨 있는 UTXO가 여기저기 산재되어 있을 뿐이다. 사용자가 보유한 비트코인 잔액이라는 것은 실물이 아니라 지갑 어플리케이션이 만들어 낸 패생개념일 뿐이다. 지갑이 사용자의 잔액을 계산하는 방법은 블록체인을 조사해서 해당 소유주가 보유하고 있는 UTXO 전부를 더하는 것이다. 
=>  비트코인은 계좌나 잔액이 존재하지 않는다. 블록체인에 흩어져 있는, 소비되지 않은 거래 출력값(UTXO)만이 존재할 뿐이다. 
UTXO는 소수점 여덟 자리인 사토시 단위로 표현되는 임의의 값을 가질 수 있다. UTXO는 한번 생성되면 해당 가치를 나눌 수 없다. UTXO가 한 거래에서 원하는 금액보다 높은 가치를 가지고 있는 경우, 해당 UTXO 전액을 소비하고 해당 거래 내에서 잔액이 생성되어야 한다. 예를 들어, 여러분이 20비트코인에 해당하는 UTXO를 보유하고 있고 1비트코인을 지불하기를 원한다고 가정해 보자. 이 경우, 거래에서는 20비트코인 UTXO 전액을 소비하고 두 개의 출력값을 생성해야 한다. 하나는 여러분이 원하는 수령인에게 지불하는 1비트코인에 대한 출력값이고, 나머지 하나는 여러분의 지갑에 잔액으로 돌려줄 19비트코인에 대한 출력값이다. 결과적으로대부분의 비트코인 거래에서는 잔액이 발생할 것이다. 
비트코인 어플리케이션에서는 여러 가지 전략을 사용하여 구매 금액을 맞출 수 있다. 작은 단위 금액을 합친다거나 정확하게 금액을 맞추는 방법, 거래 가치보다 큰 단위의 단일 단위를 사용하고 잔액을 생성하는 방법 등이 있다. 이렇게 지출 가능한 UTXO의 복잡한 경우의 수는 사용자의 지갑이 자동으로 시행하며 사용자들에게는 보이지 않는다 .
거래가 소비하는 UTXO를 거래 입력값이라고 하고 거래가 생성하는 UTXO를 거래 출력값이라고 한다. 이련 식으로 UTXO를 소비하고 생성하면서 거래 체인 속에서 비트코인 가치 덩어리들이 한 소유주에서 다른 소유주로 이동한다. 거래 내에서 현 소유주의 서명으로 UTXO의 암호를 풀어서 UTXO를 소비하고 새로운 소유주의 비트코인 주로소 UTXO를 잠가서 새로운 UTXO를 생성한다. 
입력값과 출력값 체인에 대한 예외적인 경우는 코인베이스 거래라고 불리는 특수한 유형의 거래다. 이 거래는 각 블록 내의 첫 번째 거래다 첫 거래는 채굴에 '성공'한 채굴자에 의해 생성되며, 채굴에 대한 보상으로 해당 채굴자에게 지불 가능한 새 비트코인을 생성한다. 

