# 고성능을 위한 파이썬 이해하기

- 이 장에서 배울 내용
  - 컴퓨터의 구성 요소
  - 컴퓨터 구성 요소의 다양한 종류
  - 파이썬에서 컴퓨터 구성 요소를 추상화하는 방법
  - 고성능을 위한 파이썬 코드를 작성할 때 넘어야 할 장벽
  - 성능 관련 문제의 종류

 파이썬은 하드웨어와의 상호작용을 숨기기 때문에 쉽지는 않으나 실제 데이터를 하드웨어로 옮기는 최적의 방법과 파이썬에서 데이터를 옮기는 최적의 방법을 모두 이해하면 파이썬으로 고성능 프로그램을 작성하는데 도움이 된다. 



## 컴퓨터 시스템의 기본
컴퓨터를 구성하는 요소와 속성

- 연산장치 - 초당 계산할 수 있는 처리량
- 기억장치 - 얼마나 많은 데이터를 저장할 수 있는지, 얼마나 빠르게 데이터를 읽고 쓸 수 있는지
- 연결장치 - 연산 장치와 기억 장치간 데이터를 얼마나 빠르게 옮길 수 있는지



### 연산 장치

컴퓨터를 사용하는 데 가장 핵심적인 장치로 입력받은 비트를 다른 비트로 변환하거나 프로세스의 상태를 변경한다. 연산 장치의 주요 속성은 한 사이클에 처리할 수 있는 연산의 개수와 1초에 처리할 수 있는 사이클의 횟수다. 한 사이클에 처리할 수 있는 연산의 개수는 IPC로 측정하며, 초당 사이클 횟수는 클럭 속도로 측정한다.  

클럭 속도를 높이면 초당 수행할 수 있는 연산량이 증가하므로 그 연산 장치를 사용하는 모든 프로그램의 속도가 바로 개선되며, 마찬가지로 IPC 값이 높아지면 벡터화 수준이 증가하므로 처리 성능이 급격하게 올라간다. **벡터화란 CPU가 여러 개의 데이터를 입력받아 한 번에 처리하는 것을 뜻한다.** 이런 종류의 CPU 명령을 SIMD 라고 한다. 

클럭 속도와 IPC의 향상은 모두 트랜지스터를 더 작게 만들어야 한다는 제약으로 인해 정체되었고 그 결과 `하이퍼스레딩`이나 `비순차 실행`, `멀티코어 아키텍처` 같은 방법이 나타났다. 

하이퍼 스레딩은 운영체제가 가상의 두 번째 CPU를 인식하게 한 다음, 똑똑한 하드웨어 로직이 단일 CPU의 실행 유닛에 두 스레드를 섞에 실행하도록 하는 기법이다. 잘 작동하면 단일 스레드 대비 30%까지 성능을 올릴 수 있다. 이 기법은 두 스레드가 서로 다른 실행 유닛을 사용할 때, 예를 들어 한 스레드가 실수 연산을 하고 다른 스레드가 정수 연산을 하면 잘 작동한다. 

비순차 실행은 프로그램 실행 과정에서 이전 작업 결과에 의존하지 않는 부분을 찾아내서 두 작업을 순서에 관계없이 실행하거나 혹은 동시에 실행하는 기법이다. 이 기법은 한 명령이 메모리에서 데이터를 가져오는 등의 이유로 대기하는 동안에 다른 명령을 실행할 수 있도록 함으로써 사용 가능한 자원을 최대한 활용할 수 있게 한다. 

멀티코어 아키텍처는 하나의 실행 유닛에 여러 개의 CPU를 두어 전체적인 처리량이 단일 CPU의 처리량을 능가하도록 한다. 듀얼 코어의 경우 두 개의 물리 연산 유닛이 서로 연결되어 있다. 멀티코어 아키텍처는 초당 처리할 수 있는 전체 연산의 수를 늘려주지만 모든 연산 유닛을 동시에 제대로 활용하기는 어렵다.

파이썬에서는 전역 인터프리터 락(GIL) 때문에 여러 개의 코어를 활용하기가 쉽지 않다. GIL은 현재 사용 중인 코어가 몇 개든, 한 번에 하나의 명령만 실행되도록 강제한다. 이는 표준 라이브러리인 multiprocessing 모듈이나 numexpr, Cython같은 기술을 이용하거나, 분산 컴퓨팅 모델을 사용하는 방법으로 회피할 수 있다.  



### 기억 장치

기억장치에는 메인보드의 레지스터나 RAM, 하드디스크도 포함된다. 

대부분의 기억장치는 데이터를 조금씩 자주 읽을 때보다는 한꺼번에 많이 읽을 때 훨씬 빠르게 동작한다. 전자를 임의접근, 후자를 순차접근이라 한다. 일반적으로 이러한 현상은 모든 기억 장치의 공통 특성이지만 미치는 정도는 기억 장치의 유형에 따라 다르다. 

프로그램의 메모리 사용 패턴을 최적화하려면 단순히 어떤 데이터를 어디에 저장할 것인지, 또 어떻게 저장할 것인지(순차적 읽기 속도 관련), 그리고 몇 번이나 데이터를 옮길 것인지를 최적화하면 된다. 



### 통신 계층

버스의 속성은 주어진 시간에 얼마나 많은 데이터를 전송할 수 있는지를 나타내는 속도다. 한번에 전송할 수 있는 데이터의 양을 나타내는 버스 폭(width)과 초당 몇 번을 전송할 수 있는지 나타내는 버스 주파수(Frequency)에 의해 결정된다. 한 번의 전송으로 데이터를 옮기는 과정은 순차적이다. 버스의 폭이 넓으면 필요한 데이터를 한 번에 옮길 수 있으므로 코드를 벡터화할 수 있다. 버스 폭이 좁더라도 버스 주파수가 높다면 임의의 메로리 영역을 자주 읽어야 하는 경우에 도움이 된다. 



## 기본 구성 함께 보기
성능에  관한 한 파이썬은 태생적으로 부족하다는 결론을 내리는 사람들도 있지만, 
파이썬의 빠른 개발속도와, 성능 문제를 쉽게 완화할 수 있는 모듈과 철학으로 해결할 수 있다. 

### 이상적인 컴퓨팅 vs 파이썬 가상 머신

소수를 판별하는 예제 코드이다. 

```python
import math


def check_prime(number):
    sqrt_number = math.sqrt(number)
    number_float = float(number)
    for i in range(2, int(sqrt_number) + 1):
        if (number_float / i).is_integer():
            return False
    return True


print("check_prime(1000000000) = ", check_prime(1000000000))  # 수소가 아님
print("check_prime(1000000009) = ", check_prime(1000000009))  # 수소

```



데이터를 필요한 곳에 저장하고 이동을 최소화하는 전략은 최적화에 있어서 매우 중요한 주제다. 
앞 코드의 루프에서 한 번에 i 값 하나씩만 CPU로 보내는 대신, number_float와 i값 여러 개를 동시에 검사하도록 할 것이다. 이는 CPU의 벡터화 연산 또는 여러 데이터를 입력받는 명령을 한 클럭에 실행하는 기능의 장점을 이용한 것이다. 

```python
def check_prime_v(number):
    sqrt_number = math.sqrt(number)
    number_float = float(number)
    numbers = range(2, int(sqrt_number) + 1)
    for i in range(0, len(numbers), 5):
        # 유효한 파이썬 코드가 아님
        result = (number_float / numbers[i:(i + 5)]).is_integer()
        if any(result):
            return False
    return True
```

한 번에 다섯 개의 i 값에 대한 나눗셈을 수행하고 그 결과가 정수인지 확인한다. 이 과정이 제대로 벡터화된다면 CPU는 i값을 매번 하나씩 따로 계산하지 않고 한 번에 다섯 개의 연산을 수행하게 된다. 이상적으로는 any(result) 연산 역시 결과를 RAM에 돌려주는 대신 CPU 안에서 처리할 것이다. 

위 예제는 실수를 리스트로 나눌 수 없기 때문에 유효한 파이썬 코드가 아니다. numpy 같은 외부 라이브러리가 지원하는 벡터화된 수학 연산을 이용하여 해결할 수 있다. 

파이썬은 내부적으로 잘 최적화된 명령어 집합을 실행하지만, 더 나은 성능을 위해서는 명령어 집합을 올바른 순서로 실행하도록 하는게 요령이다. search_fast와 search_slow는 둘 다 똑같은 O(n) 복잡도를 가지고 있지만 search_fast는 불필요한 계싼을 건너뛰어서 루프를 일찍 끝낼 수 있으므로 search_slow 보다 더 빠르게 작동한다. 

```python
def search_fast(haystack, needle):
    for item in haystack:
        if item == needle:
            return True
    return False


def search_slow(haystack, needle):
    return_value = False
    for item in haystack:
        if item == needle:
            return_value = True
        return return_value
```



## 파이썬을 쓰는 이유

많은 파이썬 라이브러리는 타 언어로 작성된 도구를 감싸서 다른 시스템도 쉽게 호출할 수 있도록하고 C 코드만큼 빠르게 작동한다. 파이썬은 중요하고 안정적인 다수의 라이브러리를 기본으로 제공하여 `배터리를 포함한 언어`로 묘사되기도 한다. 